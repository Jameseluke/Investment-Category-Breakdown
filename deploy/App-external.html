<!DOCTYPE html>
<html>
<head>
    <title>burndown</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",height:600,border:2,launch:function(){this._investmentSeries=[],this._epicSeries=[],this._investmentDrilldown={},this.add({xtype:"container",itemId:"toggleContainer"}),this.add({xtype:"container",itemId:"settingsContainer",id:"settings",cls:"settings"}),this.add({xtype:"container",itemId:"reportContainer",cls:"report"}),this._addSettings(),this._loadEpics(),this._hidden=!0},_loadEpics:function(){var filter1=Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"=",value:"Evolve"}),filter2=filter1.or(Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"=",value:"Discover OOM"}));this.store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Epic"],fetch:["FormattedID","Name","LeafStoryPlanEstimateTotal","InvestmentCategory","_ref"],filters:[filter2],sorters:[{property:"InvestmentCategory"}],context:this.context.getDataContext(),limit:1/0,requester:this,autoLoad:!0,listeners:{load:this._onAllDataLoaded,scope:this}})},_onAllDataLoaded:function(){var records=this.store.getRange(),that=this;_.each(records,function(record){that._addEpicToChart(record)}),this._formatData();var chart=this._createChartConfig(this._investmentSeries,Ext.getCmp("group").getValue(),Ext.getCmp("group").getValue(),"Plan Estimate by Investment Category");this.down("#reportContainer").add(chart)},_addSettings:function(){var that=this,states=Ext.create("Ext.data.Store",{fields:["grouper","epicornah"],data:[{grouper:"Epic",epicornah:!0},{grouper:"Investment Category",epicornah:!1}]}),format=Ext.create("Ext.data.Store",{fields:["grouper","storyornah"],data:[{grouper:"Percentage",storyornah:!1},{grouper:"Plan Estimate",storyornah:!0}]});this.down("#toggleContainer").add(Ext.create("Ext.Button",{text:"Show Settings",id:"hide",handler:function(){that._hidden?(Ext.getCmp("settings").show(),this.setText("Hide Settings")):(Ext.getCmp("settings").hide(),this.setText("Show Settings")),that._hidden=!that._hidden}})),this.down("#settingsContainer").add(Ext.create("Ext.form.ComboBox",{id:"group",fieldLabel:"Group By:",store:states,queryMode:"local",displayField:"grouper",valueField:"epicornah",value:!1})),this.down("#settingsContainer").add(Ext.create("Ext.form.ComboBox",{id:"format",fieldLabel:"Format:",store:format,queryMode:"local",displayField:"grouper",valueField:"storyornah",value:!1})),this.down("#settingsContainer").add({xtype:"checkboxgroup",fieldLabel:"",id:"check",columns:1,vertical:!0,items:[{boxLabel:"Show Labels",name:"lb",inputValue:"1",checked:!0},{boxLabel:"Show Tooltips",name:"tt",inputValue:"2",checked:!0}]}),this.down("#settingsContainer").add(Ext.create("Ext.Button",{text:"Generate",handler:function(){that.down("#settingsContainer").remove("backbutton"),that.down("#reportContainer").remove("chart");var chart=that._createChartConfig(that._investmentSeries,Ext.getCmp("group").getValue(),Ext.getCmp("group").getValue(),"Plan Estimate by Investment Category",!1);that.down("#reportContainer").add(chart)}})),Ext.getCmp("settings").hide()},_addEpicToChart:function(record){var category=record.get("InvestmentCategory"),data={name:record.get("FormattedID"),y:record.get("LeafStoryPlanEstimateTotal"),rallyName:record.get("Name"),status:category,ref:record.get("_ref")};void 0===this._investmentDrilldown[category]?this._investmentDrilldown[category]={name:category,id:category,data:[data]}:this._investmentDrilldown[category].data.push(data);var temp=JSON.parse(JSON.stringify(data));temp.color=this._colorFromInvestment(category),this._epicSeries.push(temp)},_formatData:function(){var that=this;_.each(this._investmentDrilldown,function(value){var total=0;_.each(value.data,function(datapoint){total+=datapoint.y}),that._investmentSeries.push({name:value.name,id:value.id,color:that._colorFromInvestment(value.name),y:total})})},_createBackButton:function(){var that=this;this.down("#toggleContainer").add(Ext.create("Ext.Button",{id:"backbutton",text:"Back",renderTo:Ext.getBody(),handler:function(){that.down("#reportContainer").remove("chart");var chart=that._createChartConfig(that._investmentSeries,Ext.getCmp("group").getValue(),Ext.getCmp("group").getValue(),"Plan Estimate by Investment Category",!1);that.down("#reportContainer").add(chart),that.down("#toggleContainer").remove("backbutton")}})),Ext.getCmp("backbutton").center()},_colorFromInvestment:function(category){var progressColors={None:"#c56f64","Short Term Growth":"#5faf4c","Strategic Growth":"#7963cb","Cost Savings":"#b5b246",Maintenance:"#c063ba","Reduce Errors & Fallouts":"#4bae8f","Order Tracking":"#cd4739","Reduced Time to Service":"#678ecd","Reduce Operational Cost":"#d08940","Product Changes":"#c75481","Technology & Capacity":"#737632"};return progressColors[category]},_formatTooltip:function(){var additional=this.point.rallyName?this.point.rallyName+"<br />":"";return"<b>"+this.point.name+"</b><br />"+additional+"<b>Plan Estimate:</b> "+this.y+"<br /><b>Percentage of Investment:</b> "+this.percentage.toFixed(1)+"%"},_createChartConfig:function(dataseries,detailed,byEpic,title,drilled){var me=this,clickChartHandler=_.isFunction(this.clickHandler)?this.clickHandler:Ext.emptyFn,height=this.height,pieHeight=.65*this.height,settings=Ext.getCmp("check").getValue();return Ext.Object.merge({xtype:"rallychart",itemId:"chart",loadMask:!1,chartData:{series:[{type:"pie",name:"Category",visible:!detailed,data:dataseries,size:pieHeight,showInLegend:!1,allowPointSelect:!1,dataLabels:{enabled:settings.lb,formatter:function(){var label=byEpic?this.point.rallyName:this.point.name;return 0!==this.y?Ext.getCmp("format").getValue()?"<b>"+label+":</b> "+this.y:"<b>"+label+":</b> "+this.percentage.toFixed(1)+"%":null},style:{color:"black"}}},{type:"pie",name:"Category",data:this._investmentSeries,showInLegend:!drilled,size:pieHeight,visible:!drilled,allowPointSelect:!1,dataLabels:{enabled:!1}},{type:"pie",name:"Epics",data:this._epicSeries,size:pieHeight,visible:detailed,allowPointSelect:!1,showInLegend:!1,dataLabels:{enabled:settings.lb,formatter:function(){return 0!==this.y?Ext.getCmp("format").getValue()?"<b>"+this.point.name+":</b> "+this.y:"<b>"+this.point.name+":</b> "+this.percentage.toFixed(1)+"%":null},style:{color:"black"}}}]},chartConfig:{chart:{type:"pie",height:height,width:this.width,spacingTop:10,spacingRight:3,spacingBottom:30,spacingLeft:3,events:{click:clickChartHandler}},tooltip:{enabled:settings.tt,formatter:this._formatTooltip,useHTML:!0},spacingTop:0,title:{text:title,color:"black"},plotOptions:{pie:{animation:!1,cursor:"pointer",shadow:!1,center:["50%","45%"],point:{events:{click:function(){var ref=this.ref;if(ref){var url=Rally.nav.Manager.getDetailUrl(ref);window.open(url,"_blank")}else{var category=this.name;console.log(category),me.down("#reportContainer").remove("chart"),console.log(me._investmentDrilldown[category].data);var chart=me._createChartConfig(me._investmentDrilldown[category].data,!1,!0,category,!0);me.down("#reportContainer").add(chart),me.down(me._createBackButton())}}}},showInLegend:!byEpic}}}},{})}});

            Rally.launchApp('CustomApp', {
                name:"burndown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .settings{margin-bottom:0}
    </style>
</head>
<body>
</body>
</html>
