<!DOCTYPE html>
<html>
<head>
    <title>burndown</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",height:600,border:2,launch:function(){this._chartData=[],this._investmentData=[],this._investmentCategories=[],this._investmentIndex=0,this._investmentSeries=[],this.add({xtype:"container",itemId:"reportContainer"}),this._loadEpics()},_loadEpics:function(){this.store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Epic"],fetch:["FormattedID","Name","LeafStoryPlanEstimateTotal","InvestmentCategory"],filters:[],sorters:[{property:"InvestmentCategory"}],context:this.context.getDataContext(),limit:1/0,requester:this,autoLoad:!0,listeners:{load:this._onAllDataLoaded,scope:this}})},_test:function(record){console.log(record.get("FormattedID"))},_addEpicToChart:function(record){var color=this._colorFromInvestment(record.get("InvestmentCategory"));this._chartData.push({name:record.get("FormattedID"),y:record.get("LeafStoryPlanEstimateTotal"),color:color,rallyName:record.get("Name"),status:record.get("InvestmentCategory"),ref:record.get("_ref")}),void 0===this._investmentCategories[this._investmentIndex]?(this._investmentCategories[this._investmentIndex]=record.get("InvestmentCategory"),this._investmentData[this._investmentIndex]=record.get("LeafStoryPlanEstimateTotal"),console.log(typeof record.get("LeafStoryPlanEstimateTotal")),console.log(this._investmentIndex)):this._investmentCategories[this._investmentIndex]===record.get("InvestmentCategory")?this._investmentData[this._investmentIndex]=this._investmentData[this._investmentIndex]+record.get("LeafStoryPlanEstimateTotal"):(this._investmentSeries.push({name:this._investmentCategories[this._investmentIndex],y:this._investmentData[this._investmentIndex],color:this._colorFromInvestment(this._investmentCategories[this._investmentIndex])}),this._investmentIndex++,this._investmentCategories[this._investmentIndex]=record.get("InvestmentCategory"),this._investmentData[this._investmentIndex]=record.get("LeafStoryPlanEstimateTotal"))},_onAllDataLoaded:function(){var records=this.store.getRange(),that=this,states=Ext.create("Ext.data.Store",{fields:["grouper","epicornah"],data:[{grouper:"Epic",epicornah:!0},{grouper:"Investment Category",epicornah:!1}]}),format=Ext.create("Ext.data.Store",{fields:["grouper","storyornah"],data:[{grouper:"Percentage",storyornah:!1},{grouper:"Plan Estimate",storyornah:!0}]});this.down("#reportContainer").add(Ext.create("Ext.form.ComboBox",{id:"group",fieldLabel:"Group By:",store:states,queryMode:"local",displayField:"grouper",valueField:"epicornah",value:!1})),this.down("#reportContainer").add(Ext.create("Ext.form.ComboBox",{id:"format",fieldLabel:"Format:",store:format,queryMode:"local",displayField:"grouper",valueField:"storyornah",value:!1})),this.down("#reportContainer").add(Ext.create("Ext.Button",{text:"Click me",renderTo:Ext.getBody(),handler:function(){that.down("#reportContainer").remove("chart"),that._showEpic=!that._showEpic;var chart=that._createChartConfig(Ext.getCmp("group").getValue(),Ext.getCmp("format").getValue());that.down("#reportContainer").add(chart)}})),_.each(records,function(record){that._addEpicToChart(record)}),this._investmentSeries.push({name:this._investmentCategories[this._investmentIndex],y:this._investmentData[this._investmentIndex],color:this._colorFromInvestment(this._investmentCategories[this._investmentIndex])});var chart=this._createChartConfig(Ext.getCmp("group").getValue(),Ext.getCmp("format").getValue());this.down("#reportContainer").add(chart)},_colorFromInvestment:function(category){var progressColors={None:"#c56f64","Short Term Growth":"#5faf4c","Strategic Growth":"#7963cb","Cost Savings":"#b5b246",Maintenance:"#c063ba","Reduce Errors & Fallouts":"#4bae8f","Order Tracking":"#cd4739","Reduced Time to Service":"#678ecd","Reduce Operational Cost":"#d08940","Product Changes":"#c75481","Technology & Capacity":"#737632"};return progressColors[category]},_createChartConfig:function(byEpic,byEstimate){var me=this,clickChartHandler=_.isFunction(this.clickHandler)?this.clickHandler:Ext.emptyFn,height=this.height,pieHeight=.65*this.height;return Ext.Object.merge({xtype:"rallychart",itemId:"chart",loadMask:!1,chartData:{series:[{type:"pie",name:"Epics",data:this._chartData,size:pieHeight,allowPointSelect:!1,showInLegend:!1,dataLabels:{enabled:byEpic,formatter:function(){return 0!==this.y?byEstimate?"<b>"+this.point.name+":</b> "+this.y:"<b>"+this.point.name+":</b> "+this.percentage.toFixed(1)+"%":null},style:{color:"black"}}},{type:"pie",name:"Category",data:this._investmentSeries,size:pieHeight,visible:!byEpic,allowPointSelect:!1,dataLabels:{enabled:!byEpic,formatter:function(){return 0!==this.y?byEstimate?"<b>"+this.point.name+":</b> "+this.y:"<b>"+this.point.name+":</b> "+this.percentage.toFixed(1)+"%":null},style:{color:"black"}}}]},chartConfig:{chart:{type:"pie",height:height,width:this.width,spacingTop:10,spacingRight:3,spacingBottom:30,spacingLeft:3,events:{click:clickChartHandler}},tooltip:{},spacingTop:0,title:{text:null},plotOptions:{pie:{animation:!1,cursor:"pointer",shadow:!1,center:["50%","45%"],point:{events:{click:function(){var ref=this.ref;ref&&(me.up("rallydialog").destroy(),Rally.nav.Manager.showDetail(ref))}}},showInLegend:!0}}}},{})}});

            Rally.launchApp('CustomApp', {
                name:"burndown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .pie-chart-legend{color:#3E576F;font-size:12px;padding:5px;border:1px solid #909090;-webkit-border-radius:5px;-moz-border-radius:5px;border-radius:5px}.pie-chart-legend .legend-swatch{width:17px;height:12px;border:1px solid #EEE;-webkit-border-radius:5px;-moz-border-radius:5px;border-radius:5px;float:left;margin:0 3px 0 6px}.pie-chart-legend .legend-swatch.none-sample-swatch{background:#c56f64}.pie-chart-legend .legend-swatch.short-sample-swatch{background:#5faf4c}.pie-chart-legend .legend-swatch.strategic-sample-swatch{background:#7963cb}.pie-chart-legend .legend-swatch.cost-sample-swatch{background:#b5b246}.pie-chart-legend .legend-swatch.maintenance-sample-swatch{background:#c063ba}.pie-chart-legend .legend-swatch.errors-sample-swatch{background:#4bae8f}.pie-chart-legend .legend-swatch.order-sample-swatch{background:#cd4739}.pie-chart-legend .legend-swatch.time-sample-swatch{background:#678ecd}.pie-chart-legend .legend-swatch.operational-sample-swatch{background:#d08940}.pie-chart-legend .legend-swatch.product-progress-sample-swatch{background:#c75481}.pie-chart-legend .legend-swatch.tech-sample-swatch{background:#737632}
    </style>
</head>
<body>
</body>
</html>
